module Transition.Concur.Cofinal.Lattice.case.nu-extrude-propagate-b where

   open import ConcurrentSlicingCommon
   import Name as á´º
   import Ren as á´¿
   open import Transition.Concur.Cofinal.Lattice.Common

   private
      base : âˆ€ {Î“ x Pâ‚€ Râ‚€ Râ€²â‚€} {a : Actionáµ‡ Î“} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
             {Eâ€² : Pâ‚€ â€”[ (á´¿.push *) a áµ‡ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡áµ‡ ] Eâ€²) (P : â†“ Pâ‚€) (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€)
             (Sâ€² : â†“ (á´¿.swap *) (tgtâ‚‚ (âŠ–â‚ ğ¸))) â†’ tgt E P â‰¡ R â†’ tgt Eâ€² P â‰¡ Râ€² â†’
             tgt ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) ((swap *Ìƒ) Râ€²) â‰¡ Sâ€² â†’
             braiding (á¶œâˆ‡áµ‡ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {(á´¿.push *) a}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡
             tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P) â†’
             braiding (áµ‡âˆ‡áµ‡ {a = â€¢ x} {a}) {0} (cong (á´¿.swap *) (Î³â‚ ğ¸)) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ Sâ€²
      base {x = x} {a = a} {E} {Eâ€²} ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² â‰¡Sâ€² IH =
         let open â‰…-Reasoning in â‰…-to-â‰¡ (
         begin
            braiding áµ‡âˆ‡áµ‡ {0} (cong (á´¿.swap *) (Î³â‚ ğ¸)) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R)
         â‰…âŸ¨ reduce-áµ‡âˆ‡áµ‡ (cong (á´¿.swap *) (Î³â‚ ğ¸)) _ âŸ©
            (swap *Ìƒ) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R)
         â‰¡âŸ¨ cong ((swap *Ìƒ) âˆ˜á¶  tgt (Eâ€²/E (âŠ–â‚ ğ¸))) (sym â‰¡R) âŸ©
            (swap *Ìƒ) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P))
         â‰…âŸ¨ â‰…-congâœ´ â†“_ (Î³â‚ ğ¸) (swap *Ìƒ) (â‰…-sym (reduce-á¶œâˆ‡áµ‡ (Î³â‚ ğ¸) _)) âŸ©
            (swap *Ìƒ) (braiding (á¶œâˆ‡áµ‡ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {(á´¿.push *) a}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)))
         â‰¡âŸ¨ cong (swap *Ìƒ) IH âŸ©
            (swap *Ìƒ) (tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
         â‰¡âŸ¨ rená¶œ-tgt-comm (E/Eâ€² (âŠ–â‚ ğ¸)) swap (tgt Eâ€² P) âŸ©
            tgt ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) ((swap *Ìƒ) (tgt Eâ€² P))
         â‰¡âŸ¨ cong (tgt ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) âˆ˜á¶  (swap *Ìƒ)) â‰¡Râ€² âŸ©
            tgt ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) ((swap *Ìƒ) Râ€²)
         â‰¡âŸ¨ â‰¡Sâ€² âŸ©
            Sâ€²
         âˆ)

   module xâ€¢
      {Î“} {x xâ€² : Name Î“} {Pâ‚€ Râ‚€ Râ€²â‚€} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
      {Eâ€² : Pâ‚€ â€”[ á´º.suc xâ€² â€¢ áµ‡ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡áµ‡ ] Eâ€²) (P : â†“ Pâ‚€)
      (IH : braiding (á¶œâˆ‡áµ‡ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {á´º.suc xâ€² â€¢}) {0} (Î³â‚ ğ¸)
            (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
      where

      private
         module _
            (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (â‰¡R : tgt E P â‰¡ R) (â‰¡Râ€² : tgt Eâ€² P â‰¡ Râ€²) where

            caseâ€² :
               braiding (áµ‡âˆ‡áµ‡ {a = â€¢ x} {xâ€² â€¢}) {0} (cong (á´¿.swap *) (Î³â‚ ğ¸))
               (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ tgt (Î½â€¢ (á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) [ Î½ (swap *Ìƒ) Râ€² ]
            caseâ€²
               with step ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) ((swap *Ìƒ) Râ€²) |
                    inspect (step ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸)))) ((swap *Ìƒ) Râ€²)
            ... | â—» , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH

      case :
         braiding (áµ‡âˆ‡áµ‡ {a = â€¢ x} {xâ€² â€¢}) {0} (cong (á´¿.swap *) (Î³â‚ ğ¸))
         (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt (Î½â€¢ E) [ Î½ P ])) â‰¡ tgt (Î½â€¢ (á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) (tgt (Î½áµ‡ Eâ€²) [ Î½ P ])
      case
         with step Eâ€² P | step E P | inspect (step Eâ€²) P | inspect (step E) P
      ... | â—» , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ ._ â€¢ áµ‡ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ ._ â€¢ áµ‡ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ ._ â€¢ áµ‡ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)

   module â€¢x
      {Î“} {x xâ€² : Name Î“} {Pâ‚€ Râ‚€ Râ€²â‚€} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
      {Eâ€² : Pâ‚€ â€”[ (â€¢ á´º.suc xâ€²) áµ‡ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡áµ‡ ] Eâ€²) (P : â†“ Pâ‚€)
      (IH : braiding (á¶œâˆ‡áµ‡ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {â€¢ á´º.suc xâ€²}) {0} (Î³â‚ ğ¸)
            (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
      where

      private
         module _
            (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (â‰¡R : tgt E P â‰¡ R) (â‰¡Râ€² : tgt Eâ€² P â‰¡ Râ€²) where

            caseâ€² :
               braiding (áµ‡âˆ‡áµ‡ {a = â€¢ x} {â€¢ xâ€²}) {0} (cong (á´¿.swap *) (Î³â‚ ğ¸))
               (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ tgt (Î½â€¢ (á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) [ Î½ (swap *Ìƒ) Râ€² ]
            caseâ€²
               with step ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) ((swap *Ìƒ) Râ€²) |
                    inspect (step ((á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸)))) ((swap *Ìƒ) Râ€²)
            ... | â—» , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH

      case :
         braiding (áµ‡âˆ‡áµ‡ {a = â€¢ x} {â€¢ xâ€²}) {0} (cong (á´¿.swap *) (Î³â‚ ğ¸))
         (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt (Î½â€¢ E) [ Î½ P ])) â‰¡ tgt (Î½â€¢ (á´¿.swap *á¶œ) (E/Eâ€² (âŠ–â‚ ğ¸))) (tgt (Î½áµ‡ Eâ€²) [ Î½ P ])
      case
         with step Eâ€² P | step E P | inspect (step Eâ€²) P | inspect (step E) P
      ... | â—» , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ (â€¢ ._) áµ‡ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ (â€¢ ._) áµ‡ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ (â€¢ ._) áµ‡ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
