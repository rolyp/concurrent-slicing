open import ConcurrentSlicingCommon
open import Transition.Concur.Cofinal.Lattice.Common
import Name as ·¥∫
import Ren as ·¥ø

module Transition.Concur.Cofinal.Lattice.case.nu-propagate-x-x
   {Œì P‚ÇÄ R‚ÇÄ R‚Ä≤‚ÇÄ} {x u : Name Œì} {E : P‚ÇÄ ‚Äî[ (‚Ä¢ ·¥∫.suc x) ·µá - _ ]‚Üí R‚ÇÄ} {E‚Ä≤ : P‚ÇÄ ‚Äî[ (‚Ä¢ ·¥∫.suc u) ·µá - _ ]‚Üí R‚Ä≤‚ÇÄ}
   (ùê∏ : E ‚å£‚ÇÅ[ À£‚àáÀ£ ] E‚Ä≤) (P : ‚Üì P‚ÇÄ)
   (let P‚Ä≤‚ÇÄ = tgt‚ÇÅ (‚äñ‚ÇÅ ùê∏); P‚Ä≥‚ÇÄ = tgt‚ÇÇ (‚äñ‚ÇÅ ùê∏))
   (IH : braiding (À£‚àáÀ£ {x = ·¥∫.suc x} {·¥∫.suc u}) {0} (Œ≥‚ÇÅ ùê∏) (tgt (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏)) (tgt E P)) ‚â° tgt (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏)) (tgt E‚Ä≤ P))
   where

   private
      base : (R : ‚Üì R‚ÇÄ) (R‚Ä≤ : ‚Üì R‚Ä≤‚ÇÄ) (S : ‚Üì (·¥ø.swap *) P‚Ä≤‚ÇÄ) (S‚Ä≤ : ‚Üì (·¥ø.swap *) P‚Ä≥‚ÇÄ) ‚Üí
             tgt E P ‚â° R ‚Üí tgt E‚Ä≤ P ‚â° R‚Ä≤ ‚Üí
             tgt ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R) ‚â° S ‚Üí tgt ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R‚Ä≤) ‚â° S‚Ä≤ ‚Üí
             braiding (À£‚àáÀ£ {x = x} {u}) {0} (cong ŒΩ_ (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏)))
             [ ŒΩ S ] ‚â° [ ŒΩ S‚Ä≤ ]

      base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ ‚â°S ‚â°S‚Ä≤ =
         let Œ± : S ‚âÖ S‚Ä≤
             Œ± = let open ‚âÖ-Reasoning in
                begin
                   S
                ‚â°‚ü® sym ‚â°S ‚ü©
                   tgt ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R)
                ‚â°‚ü® cong (tgt ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) ‚àò·∂† (swap *ÃÉ)) (sym ‚â°R) ‚ü©
                   tgt ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) (tgt E P))
                ‚â°‚ü® sym (ren·∂ú-tgt-comm (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏)) swap (tgt E P)) ‚ü©
                   (swap *ÃÉ) (tgt (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏)) (tgt E P))
                ‚âÖ‚ü® ‚âÖ-cong‚ú¥ ‚Üì_ (‚âÖ-to-‚â° (‚âÖ-trans (‚â°-to-‚âÖ (Œ≥‚ÇÅ ùê∏)) (Proc‚Ü≤ refl P‚Ä≥‚ÇÄ)))
                           (swap *ÃÉ) (‚âÖ-trans (‚âÖ-sym (reduce-À£‚àáÀ£ {x = ·¥∫.suc x} {·¥∫.suc u} (Œ≥‚ÇÅ ùê∏) _)) (‚â°-to-‚âÖ IH)) ‚ü©
                   (swap *ÃÉ) (tgt (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏)) (tgt E‚Ä≤ P))
                ‚â°‚ü® ren·∂ú-tgt-comm (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏)) swap (tgt E‚Ä≤ P) ‚ü©
                   tgt ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) (tgt E‚Ä≤ P))
                ‚â°‚ü® cong (tgt ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) ‚àò·∂† (swap *ÃÉ)) ‚â°R‚Ä≤ ‚ü©
                   tgt ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R‚Ä≤)
                ‚â°‚ü® ‚â°S‚Ä≤ ‚ü©
                   S‚Ä≤
                ‚àé
             open ‚âÖ-Reasoning in ‚âÖ-to-‚â° (
         begin
            braiding (À£‚àáÀ£ {x = x} {u}) (cong ŒΩ_ (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏))) [ ŒΩ S ]
         ‚âÖ‚ü® reduce-À£‚àáÀ£ {x = x} {u} (cong ŒΩ_ (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏))) _ ‚ü©
            [ ŒΩ S ]
         ‚âÖ‚ü® [ŒΩ-]-cong (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏)) Œ± ‚ü©
            [ ŒΩ S‚Ä≤ ]
         ‚àé)

   private
      module _
         (R : ‚Üì R‚ÇÄ) (R‚Ä≤ : ‚Üì R‚Ä≤‚ÇÄ) (‚â°R : tgt E P ‚â° R) (‚â°R‚Ä≤ : tgt E‚Ä≤ P ‚â° R‚Ä≤) where

         case‚Ä≤ :
            braiding (À£‚àáÀ£ {x = x} {u}) {0} (cong ŒΩ_ (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏)))
            (tgt (ŒΩ·∂ú (·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) [ ŒΩ (swap *ÃÉ) R ]) ‚â°
            tgt (ŒΩ·∂ú (·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) [ ŒΩ (swap *ÃÉ) R‚Ä≤ ]
         case‚Ä≤
            with step ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R) | step ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) ((swap *ÃÉ) R‚Ä≤) |
                 inspect (step ((·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏)))) ((swap *ÃÉ) R) |
                 inspect (step ((·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏)))) ((swap *ÃÉ) R‚Ä≤)
         ... | ‚óª , S | ‚óª , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | ‚óª , S | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | ‚óª , S | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S | ‚óª , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S | ‚óª , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S | [ ‚Ä¢ ._ ‚å© ‚óª ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)
         ... | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S | [ ‚Ä¢ ._ ‚å© [ .(·¥∫.suc ·¥∫.zero) ] ‚å™ ·∂ú ] , S‚Ä≤ | [ ‚â°S ] | [ ‚â°S‚Ä≤ ] =
            base  R R‚Ä≤ S S‚Ä≤ ‚â°R ‚â°R‚Ä≤ (,-inj‚ÇÇ ‚â°S) (,-inj‚ÇÇ ‚â°S‚Ä≤)

   case :
      braiding (À£‚àáÀ£ {x = x} {u}) {0} (cong ŒΩ_ (cong (·¥ø.swap *) (Œ≥‚ÇÅ ùê∏)))
      (tgt (ŒΩ·∂ú (·¥ø.swap *·∂ú) (E‚Ä≤/E (‚äñ‚ÇÅ ùê∏))) (tgt (ŒΩ·µá E) [ ŒΩ P ])) ‚â°
      tgt (ŒΩ·∂ú (·¥ø.swap *·∂ú) (E/E‚Ä≤ (‚äñ‚ÇÅ ùê∏))) (tgt (ŒΩ·µá E‚Ä≤) [ ŒΩ P ])
   case
      with step E‚Ä≤ P | step E P | inspect (step E‚Ä≤) P | inspect (step E) P
   ... | ‚óª , R‚Ä≤ | ‚óª , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | ‚óª , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | ‚óª , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R‚Ä≤ | ‚óª , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R‚Ä≤ | ‚óª , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô ‚óª Ôπö ·µá ] , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] = case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
   ... | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R‚Ä≤ | [ ‚Ä¢ ._ Ôπô [ .·¥∫.zero ] Ôπö ·µá ] , R | [ ‚â°R‚Ä≤ ] | [ ‚â°R ] =
      case‚Ä≤ R R‚Ä≤ (,-inj‚ÇÇ ‚â°R) (,-inj‚ÇÇ ‚â°R‚Ä≤)
