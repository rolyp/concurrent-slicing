module Transition.Concur.Cofinal.Lattice.Helpers.nu-propagate-c-c where

   open import ConcurrentSlicingCommon
   import Ren as á´¿
   open import Transition.Concur.Cofinal.Lattice.Common

   private
      wibble : âˆ€ {Î“ Pâ‚€ Râ‚€ Râ€²â‚€} {a aâ€² : Actioná¶œ Î“} {E : Pâ‚€ â€”[ (á´¿.push *) a á¶œ - _ ]â†’ Râ‚€} {Eâ€² : Pâ‚€ â€”[ (á´¿.push *) aâ€² á¶œ - _ ]â†’ Râ€²â‚€}
               (ğ¸ : E âŒ£â‚[ á¶œâˆ‡á¶œ ] Eâ€²) (P : â†“ Pâ‚€) (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (S : â†“ tgtâ‚ (âŠ–â‚ ğ¸)) (Sâ€² : â†“ tgtâ‚‚ (âŠ–â‚ ğ¸)) â†’
               tgt E P â‰¡ R â†’ tgt Eâ€² P â‰¡ Râ€² â†’ tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R â‰¡ S â†’ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€² â‰¡ Sâ€² â†’
               braiding (á¶œâˆ‡á¶œ {a = (á´¿.push *) a} {(á´¿.push *) aâ€²}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡
               tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P) â†’
               braiding (á¶œâˆ‡á¶œ {a = a} {aâ€²}) {0} (cong Î½_ (Î³â‚ ğ¸))
               [ Î½ S ] â‰¡ [ Î½ Sâ€² ]
      wibble {a = a} {aâ€²} {E} {Eâ€²} ğ¸ P R Râ€² S Sâ€² â‰¡R â‰¡Râ€² â‰¡S â‰¡Sâ€² IH =
         let Î± : S â‰… Sâ€²
             Î± = let open â‰…-Reasoning in
                begin
                   S
                â‰¡âŸ¨ sym â‰¡S âŸ©
                   tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R
                â‰¡âŸ¨ cong (tgt (Eâ€²/E (âŠ–â‚ ğ¸))) (sym â‰¡R) âŸ©
                   tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)
                â‰…âŸ¨ â‰…-sym (reduce-á¶œâˆ‡á¶œ (Î³â‚ ğ¸) _) âŸ©
                   braiding (á¶œâˆ‡á¶œ {a = (á´¿.push *) a} {(á´¿.push *) aâ€²}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P))
                â‰¡âŸ¨ IH âŸ©
                   tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P)
                â‰¡âŸ¨ cong (tgt (E/Eâ€² (âŠ–â‚ ğ¸))) â‰¡Râ€² âŸ©
                   tgt (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€²
                â‰¡âŸ¨ â‰¡Sâ€² âŸ©
                   Sâ€²
                âˆ
             open â‰…-Reasoning in â‰…-to-â‰¡ (
         begin
            braiding á¶œâˆ‡á¶œ (cong Î½_ (Î³â‚ ğ¸)) [ Î½ S ]
         â‰…âŸ¨ reduce-á¶œâˆ‡á¶œ (cong Î½_ (Î³â‚ ğ¸)) _  âŸ©
            [ Î½ S ]
         â‰…âŸ¨ [Î½-]-cong (Î³â‚ ğ¸) Î± âŸ©
            [ Î½ Sâ€² ]
         âˆ)

   module â€¢xâŒ©yâŒª-â€¢xâŒ©yâŒª
      {Î“ Pâ‚€ Râ‚€ Râ€²â‚€} {x y xâ€² yâ€² : Name Î“} {E : Pâ‚€ â€”[ â€¢ á´¿.push x âŒ© á´¿.push y âŒª á¶œ - _ ]â†’ Râ‚€}
      {Eâ€² : Pâ‚€ â€”[ â€¢ á´¿.push xâ€² âŒ© á´¿.push yâ€² âŒª á¶œ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡á¶œ ] Eâ€²) (P : â†“ Pâ‚€)
      (let Pâ€²â‚€ = tgtâ‚ (âŠ–â‚ ğ¸); Pâ€³â‚€ = tgtâ‚‚ (âŠ–â‚ ğ¸))
      (IH : braiding (á¶œâˆ‡á¶œ {a = â€¢ á´¿.push x âŒ© á´¿.push y âŒª} {â€¢ á´¿.push xâ€² âŒ© á´¿.push yâ€² âŒª}) {0} (Î³â‚ ğ¸)
            (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
      where

      module sub
         (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (â‰¡R : tgt E P â‰¡ R) (â‰¡Râ€² : tgt Eâ€² P â‰¡ Râ€²) where

         caseâ€² :
            braiding (á¶œâˆ‡á¶œ {a = â€¢ x âŒ© y âŒª} {â€¢ xâ€² âŒ© yâ€² âŒª}) {0} (cong Î½_ (Î³â‚ ğ¸))
            (Ï€â‚‚ (stepâ» (Î½á¶œ Eâ€²/E (âŠ–â‚ ğ¸)) (Î½ R))) â‰¡
            Ï€â‚‚ (stepâ» (Î½á¶œ E/Eâ€² (âŠ–â‚ ğ¸)) (Î½ Râ€²))
         caseâ€²
            with step (Eâ€²/E (âŠ–â‚ ğ¸)) R | step (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€² |
                 inspect (step (Eâ€²/E (âŠ–â‚ ğ¸))) R | inspect (step (E/Eâ€² (âŠ–â‚ ğ¸))) Râ€²
         caseâ€² | â—» , Pâ€² | â—» , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | â—» , Pâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | â—» , Pâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€² | â—» , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€² | â—» , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH
         caseâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Pâ€³ | [ â‰¡Pâ€² ] | [ â‰¡Pâ€³ ] =
            wibble ğ¸ P R Râ€² Pâ€² Pâ€³ â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Pâ€²) (,-injâ‚‚ â‰¡Pâ€³) IH

      open sub

      case :
         braiding (á¶œâˆ‡á¶œ {a = â€¢ x âŒ© y âŒª} {â€¢ xâ€² âŒ© yâ€² âŒª}) {0} (cong Î½_ (Î³â‚ ğ¸))
         (tgt (Î½á¶œ Eâ€²/E (âŠ–â‚ ğ¸)) (tgt (Î½á¶œ E) [ Î½ P ])) â‰¡
         tgt (Î½á¶œ E/Eâ€² (âŠ–â‚ ğ¸)) (tgt (Î½á¶œ Eâ€²) [ Î½ P ])
      case
         with step Eâ€² P | step E P | inspect (step Eâ€²) P | inspect (step E) P
      ... | â—» , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] =
         caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
