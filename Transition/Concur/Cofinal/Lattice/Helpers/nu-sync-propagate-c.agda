module Transition.Concur.Cofinal.Lattice.Helpers.nu-sync-propagate-c where

   open import ConcurrentSlicingCommon
   import Name as á´º
   import Ren as á´¿
   open import Transition.Concur.Cofinal.Lattice.Common

   private
      base : âˆ€ {Î“ x Pâ‚€ Râ‚€ Râ€²â‚€} {a : Actioná¶œ Î“} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
             {Eâ€² : Pâ‚€ â€”[ (á´¿.push *) a á¶œ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡á¶œ ] Eâ€²) (P : â†“ Pâ‚€) (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€)
             (Sâ€² : â†“ tgtâ‚‚ (âŠ–â‚ ğ¸)) â†’ tgt E P â‰¡ R â†’ tgt Eâ€² P â‰¡ Râ€² â†’ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€² â‰¡ Sâ€² â†’
             braiding (á¶œâˆ‡á¶œ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {(á´¿.push *) a}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡
             tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P) â†’
             braiding (áµ‡âˆ‡á¶œ {a = â€¢ x} {a}) {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ Sâ€²
      base {x = x} {a = a} {E} {Eâ€²} ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² â‰¡Sâ€² IH =
         let open â‰…-Reasoning in â‰…-to-â‰¡ (
         begin
            braiding áµ‡âˆ‡á¶œ {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R)
         â‰…âŸ¨ reduce-áµ‡âˆ‡á¶œ (Î³â‚ ğ¸) _ âŸ©
            tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R
         â‰¡âŸ¨ cong (tgt (Eâ€²/E (âŠ–â‚ ğ¸))) (sym â‰¡R) âŸ©
            tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)
         â‰…âŸ¨ â‰…-sym (reduce-á¶œâˆ‡á¶œ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {(á´¿.push *) a} (Î³â‚ ğ¸) _) âŸ©
            braiding á¶œâˆ‡á¶œ {0} (Î³â‚ ğ¸) (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P))
         â‰¡âŸ¨ IH âŸ©
            tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P)
         â‰¡âŸ¨ cong (tgt (E/Eâ€² (âŠ–â‚ ğ¸))) â‰¡Râ€² âŸ©
            tgt (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€²
         â‰¡âŸ¨ â‰¡Sâ€² âŸ©
            Sâ€²
         âˆ)

   module â€¢xâŒ©yâŒª
      {Î“} {x xâ€² y : Name Î“} {Pâ‚€ Râ‚€ Râ€²â‚€} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
      {Eâ€² : Pâ‚€ â€”[ â€¢ á´º.suc xâ€² âŒ© á´º.suc y âŒª á¶œ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡á¶œ ] Eâ€²) (P : â†“ Pâ‚€)
      (IH : braiding (á¶œâˆ‡á¶œ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {â€¢ á´º.suc xâ€² âŒ© á´º.suc y âŒª}) {0} (Î³â‚ ğ¸)
            (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
      where

      private
         module _
            (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (â‰¡R : tgt E P â‰¡ R) (â‰¡Râ€² : tgt Eâ€² P â‰¡ Râ€²) where

            caseâ€² : braiding (áµ‡âˆ‡á¶œ {a = â€¢ x} {â€¢ xâ€² âŒ© y âŒª}) {0} (Î³â‚ ğ¸)
                   (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ tgt (Î½â€¢ E/Eâ€² (âŠ–â‚ ğ¸)) [ Î½ Râ€² ]
            caseâ€²
               with step (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€² | inspect (step (E/Eâ€² (âŠ–â‚ ğ¸))) Râ€²
            ... | â—» , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© [ .á´º.zero ] âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH

      case :
         braiding (áµ‡âˆ‡á¶œ {a = â€¢ x} {â€¢ xâ€² âŒ© y âŒª}) {0} (Î³â‚ ğ¸)
         (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt (Î½â€¢ E) [ Î½ P ])) â‰¡ tgt (Î½â€¢ E/Eâ€² (âŠ–â‚ ğ¸)) (tgt (Î½á¶œ Eâ€²) [ Î½ P ])
      case
         with step Eâ€² P | step E P | inspect (step Eâ€²) P | inspect (step E) P
      ... | â—» , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)

   module Ï„
      {Î“} {x : Name Î“} {Pâ‚€ Râ‚€ Râ€²â‚€} {E : Pâ‚€ â€”[ â€¢ á´º.suc x âŒ© á´º.zero âŒª á¶œ - _ ]â†’ Râ‚€}
      {Eâ€² : Pâ‚€ â€”[ Ï„ á¶œ - _ ]â†’ Râ€²â‚€} (ğ¸ : E âŒ£â‚[ á¶œâˆ‡á¶œ ] Eâ€²) (P : â†“ Pâ‚€)
      (IH : braiding (á¶œâˆ‡á¶œ {a = â€¢ á´º.suc x âŒ© á´º.zero âŒª} {Ï„}) {0} (Î³â‚ ğ¸)
            (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt E P)) â‰¡ tgt (E/Eâ€² (âŠ–â‚ ğ¸)) (tgt Eâ€² P))
      where

      private
         module _
            (R : â†“ Râ‚€) (Râ€² : â†“ Râ€²â‚€) (â‰¡R : tgt E P â‰¡ R) (â‰¡Râ€² : tgt Eâ€² P â‰¡ Râ€²) where

            caseâ€² : braiding (áµ‡âˆ‡á¶œ {a = â€¢ x} {Ï„}) {0} (Î³â‚ ğ¸)
                   (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) R) â‰¡ tgt (Î½â€¢ E/Eâ€² (âŠ–â‚ ğ¸)) [ Î½ Râ€² ]
            caseâ€²
               with step (E/Eâ€² (âŠ–â‚ ğ¸)) Râ€² | inspect (step (E/Eâ€² (âŠ–â‚ ğ¸))) Râ€²
            ... | â—» , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH
            ... | [ â€¢ ._ âŒ© [ .á´º.zero ] âŒª á¶œ ] , Sâ€² | [ â‰¡Sâ€² ] = base ğ¸ P R Râ€² Sâ€² â‰¡R â‰¡Râ€² (,-injâ‚‚ â‰¡Sâ€²) IH

      case :
         braiding (áµ‡âˆ‡á¶œ {a = â€¢ x} {Ï„}) {0} (Î³â‚ ğ¸)
         (tgt (Eâ€²/E (âŠ–â‚ ğ¸)) (tgt (Î½â€¢ E) [ Î½ P ])) â‰¡ tgt (Î½â€¢ E/Eâ€² (âŠ–â‚ ğ¸)) (tgt (Î½á¶œ Eâ€²) [ Î½ P ])
      case
         with step Eâ€² P | step E P | inspect (step Eâ€²) P | inspect (step E) P
      ... | â—» , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | â—» , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ Ï„ á¶œ ] , Râ€² | â—» , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ Ï„ á¶œ ] , Râ€² | [ â€¢ ._ âŒ© â—» âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
      ... | [ Ï„ á¶œ ] , Râ€² | [ â€¢ ._ âŒ© [ ._ ] âŒª á¶œ ] , R | [ â‰¡Râ€² ] | [ â‰¡R ] = caseâ€² R Râ€² (,-injâ‚‚ â‰¡R) (,-injâ‚‚ â‰¡Râ€²)
